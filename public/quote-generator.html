<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,viewport-fit=cover"
  />
  <title>Quote Generator</title>

  <!-- Tailwind via CDN is fine for a standalone public page.
       If you prefer your project CSS pipeline, you can remove this and use your compiled CSS. -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Minor helpers */
    .form-grid { display: grid; grid-template-columns: repeat(6, minmax(0, 1fr)); gap: 1rem; }
    .field { grid-column: span 3 / span 3; }
    .field-2 { grid-column: span 2 / span 2; }
    .field-1 { grid-column: span 1 / span 1; }
    @media (max-width: 768px) {
      .field, .field-2, .field-1 { grid-column: span 6 / span 6; }
    }
    .btn { @apply inline-flex items-center justify-center px-4 py-2 rounded-lg font-medium border transition; }
    .btn-primary { @apply bg-amber-700 text-white border-amber-800 hover:bg-amber-800; }
    .btn-secondary { @apply bg-white text-amber-800 border-amber-800 hover:bg-amber-50; }
  </style>
</head>
<body class="bg-amber-50 text-zinc-900">
  <div class="max-w-5xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold text-amber-800">Quote Generator</h1>
      <p class="text-sm text-zinc-600">Fill the form and generate a printable/exportable quote.</p>
    </header>

    <form id="quote-form" class="space-y-6 bg-white p-6 rounded-2xl shadow">
      <!-- Customer block -->
      <section>
        <h2 class="text-lg font-semibold text-amber-800 mb-3">Customer</h2>
        <div class="form-grid">
          <div class="field">
            <label class="block text-sm font-medium mb-1">Customer Name</label>
            <input id="customer_name" type="text" class="w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-800" placeholder="John Doe" required />
          </div>
          <div class="field">
            <label class="block text-sm font-medium mb-1">Company</label>
            <input id="customer_company" type="text" class="w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-800" placeholder="Acme Imports" />
          </div>
          <div class="field">
            <label class="block text-sm font-medium mb-1">Email</label>
            <input id="customer_email" type="email" class="w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-800" placeholder="buyer@acme.com" />
          </div>
          <div class="field">
            <label class="block text-sm font-medium mb-1">Address</label>
            <input id="customer_address" type="text" class="w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-800" placeholder="Street, City, Country" />
          </div>
          <div class="field-2">
            <label class="block text-sm font-medium mb-1">Currency</label>
            <select id="currency" class="w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-800">
              <option value="R">ZAR (R)</option>
              <option value="$">USD ($)</option>
              <option value="€">EUR (€)</option>
              <option value="£">GBP (£)</option>
            </select>
          </div>
          <div class="field-2">
            <label class="block text-sm font-medium mb-1">Incoterm</label>
            <div class="flex items-center gap-2">
              <select id="incoterm" class="w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-800">
                <option value="EXW">EXW</option>
                <option value="FOB">FOB</option>
                <option value="CFR">CFR</option>
                <option value="CIF">CIF</option>
                <option value="DAP">DAP</option>
                <option value="DDP">DDP</option>
              </select>
              <input id="port" type="text" class="w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-800" placeholder="Port/Place" />
            </div>
          </div>
          <div class="field-2">
            <label class="block text-sm font-medium mb-1">Quote #</label>
            <input id="quote_number" type="text" class="w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-800" placeholder="AUTO or custom" />
          </div>
        </div>
      </section>

      <!-- Products -->
      <section>
        <h2 class="text-lg font-semibold text-amber-800 mb-3">Products</h2>

        <div id="products" class="space-y-3"></div>

        <button id="add-product" type="button" class="btn btn-secondary mt-2">
          + Add product
        </button>
      </section>

      <!-- Notes -->
      <section>
        <h2 class="text-lg font-semibold text-amber-800 mb-3">Notes</h2>
        <textarea id="notes" rows="4" class="w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-800" placeholder="Payment terms, delivery, additional info..."></textarea>
      </section>

      <div class="flex flex-wrap gap-3 justify-end">
        <button type="reset" class="btn btn-secondary">Reset</button>
        <button id="generate" type="submit" class="btn btn-primary">Generate Quote</button>
      </div>
    </form>
  </div>

  <template id="product-row-tpl">
    <div class="grid grid-cols-12 gap-3 items-end">
      <div class="col-span-12 md:col-span-3">
        <label class="block text-sm font-medium mb-1">Brand</label>
        <select name="product_brand" class="w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-800">
          <option value="" disabled selected>Select brand</option>
          <option>D'Aria</option>
          <option>Namaqua</option>
          <option>Cape West</option>
          <option>Goiya</option>
        </select>
      </div>
      <div class="col-span-12 md:col-span-3">
        <label class="block text-sm font-medium mb-1">Product</label>
        <select name="product_name" class="w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-800" disabled>
          <option value="" disabled selected>Select product</option>
        </select>
      </div>
      <div class="col-span-6 md:col-span-2">
        <label class="block text-sm font-medium mb-1">Qty</label>
        <input name="qty" type="number" min="1" value="1" class="w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-800" />
      </div>
      <div class="col-span-6 md:col-span-2">
        <label class="block text-sm font-medium mb-1">Unit Price</label>
        <input name="unit_price" type="number" step="0.01" min="0" value="0" class="w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-800" />
      </div>
      <div class="col-span-12 md:col-span-2">
        <button type="button" class="w-full btn btn-secondary border-red-300 text-red-700 hover:bg-red-50 remove-row">Remove</button>
      </div>
    </div>
  </template>

  <script>
    // --- Simple product catalog to enable brand -> product dependency
    const PRODUCT_CATALOG = {
      "D'Aria": ["Songbird Sauvignon Blanc", "Blush Rosé", "Merlot"],
      "Namaqua": ["Sweet Rosé", "Dry White", "Cabernet Sauvignon"],
      "Cape West": ["Chenin Blanc", "Shiraz", "Chardonnay"],
      "Goiya": ["Sauvignon Blanc", "Cabernet Sauvignon"]
    };

    // --- Helpers
    const fmtMoney = (symbol, n) => `${symbol}${Number(n || 0).toFixed(2)}`;

    function addProductRow() {
      const tpl = document.getElementById('product-row-tpl');
      const row = tpl.content.firstElementChild.cloneNode(true);
      const brandSelect = row.querySelector('[name="product_brand"]');
      const productSelect = row.querySelector('[name="product_name"]');

      brandSelect.addEventListener('change', () => {
        const brand = brandSelect.value;
        const products = PRODUCT_CATALOG[brand] || [];
        productSelect.innerHTML = '<option value="" disabled selected>Select product</option>';
        for (const p of products) {
          const opt = document.createElement('option');
          opt.value = p;
          opt.textContent = p;
          productSelect.appendChild(opt);
        }
        productSelect.disabled = products.length === 0;
      });

      row.querySelector('.remove-row').addEventListener('click', () => row.remove());
      document.getElementById('products').appendChild(row);
    }

    function readForm() {
      const currencySel = document.getElementById('currency');
      const symbol = currencySel.value;
      const code = currencySel.options[currencySel.selectedIndex].text.split(' ')[0];

      // Collect products
      const rows = Array.from(document.querySelectorAll('#products > div.grid'));
      const items = rows.map(r => {
        const brand = r.querySelector('[name="product_brand"]').value || '';
        const name = r.querySelector('[name="product_name"]').value || '';
        const qty = parseFloat(r.querySelector('[name="qty"]').value || '0');
        const unit = parseFloat(r.querySelector('[name="unit_price"]').value || '0');
        const line_total = qty * unit;
        return { brand, name, qty, unit, line_total };
      }).filter(x => x.name);

      const subtotal = items.reduce((a, b) => a + b.line_total, 0);

      const incoterm = document.getElementById('incoterm').value;
      const port = document.getElementById('port').value;
      const quoteNo = document.getElementById('quote_number').value || `Q-${Date.now().toString().slice(-6)}`;

      return {
        customer_name: document.getElementById('customer_name').value,
        customer_company: document.getElementById('customer_company').value,
        customer_email: document.getElementById('customer_email').value,
        customer_address: document.getElementById('customer_address').value,
        currency_symbol: symbol, currency_code: code,
        incoterm, port, quote_no: quoteNo,
        items, subtotal,
        notes: document.getElementById('notes').value
      };
    }

    function generateQuoteHTML(form) {
      const rows = form.items.map((it, i) => `
        <tr>
          <td class="px-3 py-2 border-b">${i + 1}</td>
          <td class="px-3 py-2 border-b">${it.brand || '-'}</td>
          <td class="px-3 py-2 border-b">${it.name}</td>
          <td class="px-3 py-2 border-b text-right">${it.qty}</td>
          <td class="px-3 py-2 border-b text-right">${fmtMoney(form.currency_symbol, it.unit)}</td>
          <td class="px-3 py-2 border-b text-right">${fmtMoney(form.currency_symbol, it.line_total)}</td>
        </tr>
      `).join('');

      const incotermFull = form.port ? `${form.incoterm} (${form.port}) Incoterms® 2020` : `${form.incoterm} Incoterms® 2020`;

      // IMPORTANT: include export libraries INSIDE the popup so the buttons work
      return `<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quotation ${form.quote_no}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print { #button-bar { display: none !important; } }
  </style>
</head>
<body class="bg-white text-zinc-900">
  <div id="button-bar" class="sticky top-0 z-10 bg-amber-50 border-b border-amber-200 px-4 py-3 flex gap-2 justify-end">
    <button id="download-word-btn" class="inline-flex items-center px-3 py-2 rounded-lg bg-white text-amber-800 border border-amber-800 hover:bg-amber-50">Download Word</button>
    <button id="download-pdf-btn" class="inline-flex items-center px-3 py-2 rounded-lg bg-amber-700 text-white border border-amber-800 hover:bg-amber-800">Download PDF</button>
    <button onclick="window.print()" class="inline-flex items-center px-3 py-2 rounded-lg bg-white text-amber-800 border border-amber-800 hover:bg-amber-50">Print</button>
  </div>

  <main id="quote-root" class="max-w-4xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold text-amber-800">Quotation</h1>
      <div class="text-sm text-zinc-600">Quote #: ${form.quote_no}</div>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="space-y-1">
        <div class="font-semibold">Bill To</div>
        <div>${form.customer_name || ''}</div>
        <div>${form.customer_company || ''}</div>
        <div>${form.customer_email || ''}</div>
        <div>${form.customer_address || ''}</div>
      </div>
      <div class="space-y-1">
        <div><span class="font-semibold">Currency:</span> ${form.currency_code}</div>
        <div><span class="font-semibold">Incoterms:</span> ${incotermFull}</div>
        <div><span class="font-semibold">Date:</span> ${new Date().toLocaleDateString()}</div>
      </div>
    </section>

    <section class="mb-6">
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-amber-100">
            <th class="px-3 py-2 text-left">#</th>
            <th class="px-3 py-2 text-left">Brand</th>
            <th class="px-3 py-2 text-left">Product</th>
            <th class="px-3 py-2 text-right">Qty</th>
            <th class="px-3 py-2 text-right">Unit</th>
            <th class="px-3 py-2 text-right">Line Total</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
        <tfoot>
          <tr class="border-t">
            <td colspan="5" class="px-3 py-2 text-right font-semibold">Subtotal</td>
            <td class="px-3 py-2 text-right font-semibold">${fmtMoney(form.currency_symbol, form.subtotal)}</td>
          </tr>
        </tfoot>
      </table>
    </section>

    ${form.notes ? `
    <section class="mb-6">
      <div class="font-semibold mb-1">Notes</div>
      <div class="text-sm whitespace-pre-wrap">${form.notes}</div>
    </section>` : ''}

    <footer class="text-xs text-zinc-500 mt-8">
      Generated by Quote Generator
    </footer>
  </main>

  <!-- Export libs (must be in the popup so handlers work) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" integrity="sha512-5x3b7R3v7Hq8+vPa8mYb+1v7YH3S3b7Ue3pV0EJvW/4m8i1z6m0YFZpYx9QfF6eX3k6nVqk3VFQFzO2s2+7G5A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-docx-js/0.4.1/html-docx.min.js" integrity="sha512-Fzs7ix6qY3wVhVtH0mN3oXbctb9w6QeYh0mR7xexyY5xq9F7hKZ6A0kzM0NQ9JkH7+QiwQ2jD7G0Hk1jS2qjVQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5Y0wGk4m9c+oY0b9+0uoQ6XWmQQ2ZcT1t3rkcZQnmd2dJQW1YwslM5o8xQm9m5i8d0o8QhQ2x3bYw2+N6gA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-Ycs0M5FzZkQ5gK0jYl2E7rK3i8r0q8U8cVdY4wzqVb8jQKX4KXr3/0M7JrJqjRzv3eB1f5w1pI1p3O1w6mVPGw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    (function() {
      const fileBase = 'Quotation-${form.quote_no}';
      const buttons = () => ({
        bar: document.getElementById('button-bar'),
        pdf: document.getElementById('download-pdf-btn'),
        docx: document.getElementById('download-word-btn'),
      });

      // Word export
      document.getElementById('download-word-btn').addEventListener('click', () => {
        try {
          const content = document.getElementById('quote-root').cloneNode(true);
          // Remove the sticky bar if cloned accidentally
          const tmp = document.createElement('div');
          tmp.appendChild(content);
          const html = '<!DOCTYPE html><html><head><meta charset="utf-8"></head><body>' + tmp.innerHTML + '</body></html>';
          const blob = window.htmlDocx.asBlob(html);
          saveAs(blob, fileBase + '.docx');
        } catch (err) {
          console.error('DOCX Error', err);
          alert('Error generating Word document.');
        }
      });

      // PDF export
      document.getElementById('download-pdf-btn').addEventListener('click', async () => {
        const { jsPDF } = window.jspdf || {};
        if (!jsPDF) { alert('PDF engine not loaded yet—try again.'); return; }

        const { bar } = buttons();
        const root = document.getElementById('quote-root');
        bar.style.display = 'none'; // hide controls from snapshot

        try {
          const canvas = await html2canvas(root, { scale: 2 });
          const imgData = canvas.toDataURL('image/png');
          const pdf = new jsPDF('p', 'pt', 'a4');
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();

          // Fit content width-wise
          const imgWidth = pageWidth;
          const imgHeight = canvas.height * (imgWidth / canvas.width);

          let y = 0;
          while (y < imgHeight) {
            if (y > 0) pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, -y, imgWidth, imgHeight);
            y += pageHeight;
          }
          pdf.save(fileBase + '.pdf');
        } catch (err) {
          console.error('PDF Error', err);
          alert('Error generating PDF.');
        } finally {
          bar.style.display = 'flex';
        }
      });
    })();
  </script>
</body>
</html>`;
    }

    // --- Wire up UI
    document.getElementById('add-product').addEventListener('click', addProductRow);
    // Add one row initially
    addProductRow();

    document.getElementById('quote-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const data = readForm();

      // Open popup and WRITE the full HTML into it so scripts load & run
      const w = window.open('', '_blank');
      if (!w) {
        alert('Please allow pop-ups for this site to view and export the quote.');
        return;
      }
      const html = generateQuoteHTML(data);
      w.document.open();
      w.document.write(html);
      w.document.close();
      // Focus for better UX in Bolt.new preview
      w.focus();
    });
  </script>
</body>
</html>
